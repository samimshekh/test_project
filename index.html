<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Orders – Advanced UI (Multi Records)</title>
<style>
  :root{
    --bg: #0f1117;
    --fg: #e5e7eb;
    --muted: #9ca3af;
    --card: #151922;
    --accent: #6366f1;
    --accent-2: #22c55e;
    --accent-3: #ef4444;
    --border: #1f2430;
    --radius: 14px;
    --shadow: 0 10px 30px rgba(0,0,0,.2);
    --transition: all .2s ease;
    color-scheme: dark;
  }
  *{ box-sizing: border-box; }
  html, body{ height:100%; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif; }
  a{ color: var(--accent); text-decoration: none; }
  .container{
    max-width: 1250px; margin: 40px auto; padding: 0 16px;
  }
  h1{
    font-size: 1.8rem; margin-bottom: 8px; line-height: 1.2;
  }
  .subtitle{ color: var(--muted); margin-bottom: 30px; }

  .card{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 24px;
    margin-bottom: 24px;
  }

  .grid{
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
  }

  .stat{
    display: flex; flex-direction: column; gap: 6px;
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: rgba(255,255,255,0.01);
  }
  .stat .label{ color: var(--muted); font-size: .75rem; text-transform: uppercase; letter-spacing: .06em; }
  .stat .value{ font-size: 1.05rem; font-weight: 600; }

  .badge{
    display: inline-flex; align-items: center; gap: 6px;
    padding: 2px 8px; border-radius: 999px; font-size: .8rem; font-weight: 600;
    text-transform: capitalize;
  }
  .badge.completed{ background: rgba(34,197,94,.12); color: var(--accent-2); }
  .badge.pending{ background: rgba(234,179,8,.12); color: #eab308; }
  .badge.failed{ background: rgba(239,68,68,.12); color: var(--accent-3); }

  button{
    appearance: none; border: 0; cursor: pointer;
    border-radius: 10px; padding: 10px 16px; font-size: 0.95rem; font-weight: 600;
    background: var(--accent); color: #fff; transition: var(--transition);
  }
  button:disabled{ opacity: .5; cursor: not-allowed; }
  button.outline{
    background: transparent; border: 1px solid var(--border); color: var(--fg);
  }
  button:hover{ opacity: .92; }

  table{
    width: 100%; border-collapse: collapse; overflow: hidden;
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }
  thead{ background: rgba(255,255,255,.02); }
  th, td{
    padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  tbody tr:hover{ background: rgba(255,255,255,.02); }
  .nowrap{ white-space: nowrap; }

  .actions{
    display:flex; gap:10px; flex-wrap: wrap; margin-top: 16px;
  }

  /* Modal */
  dialog{
    width: min(100%, 1000px); max-height: 85vh;
    border: 0; border-radius: var(--radius); padding: 0;
    background: var(--card); color: var(--fg); box-shadow: var(--shadow);
  }
  dialog::backdrop{
    background: rgba(0,0,0,.6);
    backdrop-filter: blur(2px);
  }
  .modal-header{
    padding: 20px 24px; border-bottom: 1px solid var(--border);
    display:flex; align-items:center; justify-content: space-between;
  }
  .modal-body{
    padding: 20px 24px; overflow: auto; max-height: calc(85vh - 130px);
  }
  .modal-footer{
    padding: 16px 24px; border-top: 1px solid var(--border); display:flex; justify-content: flex-end; gap: 10px;
  }

  .search-sort{
    display:flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 14px;
  }
  .search-sort input, .search-sort select{
    background: rgba(255,255,255,.03); border: 1px solid var(--border); color: var(--fg);
    border-radius: 8px; padding: 8px 10px; outline: none;
  }
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    background: rgba(255,255,255,.03); border: 1px solid var(--border);
    border-radius: 999px; padding: 4px 10px; font-size: .85rem; color: var(--muted);
  }

  @media (max-width:600px){
    th, td{ font-size: .85rem; }
    .modal-header h2{ font-size: 1.1rem; }
  }
</style>
</head>
<body>
<div class="container">
  <h1>Orders (Multi-record UI)</h1>
  <p class="subtitle">Single-file vanilla JS – global search, filters, per-order modal & CSV exports</p>

  <!-- Global Controls -->
  <div class="card">
    <div class="search-sort">
      <input type="text" id="globalSearch" placeholder="Global Search: id, user_id, status, date, amount ..." />
      <select id="globalStatusFilter">
        <option value="">All Status</option>
        <option value="completed">Completed</option>
        <option value="pending">Pending</option>
      </select>
      <select id="globalSortBy">
        <option value="created-desc">Created At ↓</option>
        <option value="created-asc">Created At ↑</option>
        <option value="amount-desc">Total Amount ↓</option>
        <option value="amount-asc">Total Amount ↑</option>
      </select>
      <span class="pill">Orders: <span id="ordersCount">0</span></span>
      <span class="pill">Grand Sum: ₹<span id="grandSum">0</span></span>
      <button id="exportAllCsvBtn">Export All CSV</button>
      <button class="outline" id="copyAllJsonBtn" title="Copy whole JSON">Copy JSON</button>
    </div>
  </div>

  <!-- Orders List -->
  <div id="ordersList"></div>

  <!-- Raw Data -->
  <div class="card">
    <h2 style="margin-bottom:12px;">Raw Data Preview</h2>
    <pre id="rawData" style="background: rgba(255,255,255,.02); border:1px solid var(--border); border-radius:10px; padding:16px; overflow:auto; max-height:240px;"></pre>
  </div>
</div>

<!-- Reusable Modal -->
<dialog id="ordersModal">
  <div class="modal-header">
    <h2 id="modalTitle">Order Summary</h2>
    <button class="outline" id="closeOrdersBtn" aria-label="Close">&times;</button>
  </div>
  <div class="modal-body">
    <div class="search-sort">
      <input type="text" id="searchBox" placeholder="Search by time / status / amount ..." />
      <select id="statusFilter">
        <option value="">All Status</option>
        <option value="completed">Completed</option>
        <option value="pending">Pending</option>
      </select>
      <select id="sortBy">
        <option value="time-desc">Time ↓</option>
        <option value="time-asc">Time ↑</option>
        <option value="amount-desc">Amount ↓</option>
        <option value="amount-asc">Amount ↑</option>
      </select>
      <span class="pill">Rows: <span id="rowsCount">0</span></span>
      <span class="pill">Sum: ₹<span id="sumAmount">0</span></span>
    </div>

    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th class="nowrap">Amount (₹)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="ordersTbody"></tbody>
      </table>
    </div>
  </div>
  <div class="modal-footer">
    <button class="outline" id="downloadCsvBtn">Download CSV (This Order)</button>
    <button id="closeOrdersBtn2">Close</button>
  </div>
</dialog>

<script>
/** ------------------ Helpers ------------------ */
function parseOrderSummary(str){
  if(!str) return [];
  return str.split(',').map((row, idx) => {
    const [time, amount, status] = row.split('|');
    return { id: idx + 1, time, amount: Number(amount), status };
  });
}

function formatCurrency(n){
  return n.toLocaleString("en-IN", { maximumFractionDigits: 2 });
}

function statusBadge(status){
  const cls = status === 'completed' ? 'completed' :
              status === 'pending' ? 'pending' : 'failed';
  return `<span class="badge ${cls}">${status}</span>`;
}

function el(tag, attrs = {}, children = []){
  const node = document.createElement(tag);
  Object.entries(attrs).forEach(([k, v]) => {
    if(k === 'class') node.className = v;
    else if(k.startsWith('on') && typeof v === 'function') node.addEventListener(k.slice(2), v);
    else node.setAttribute(k, v);
  });
  children.forEach(c => {
    if(typeof c === 'string') node.insertAdjacentHTML('beforeend', c);
    else node.appendChild(c);
  });
  return node;
}

function sumAllOrders(arr){
  return arr.reduce((acc, o) => acc + (Number(o.amount) || 0), 0);
}

/** ------------------ DOM refs ------------------ */
const ordersList = document.getElementById('ordersList');
const rawDataEl = document.getElementById('rawData');
const ordersCountEl = document.getElementById('ordersCount');
const grandSumEl = document.getElementById('grandSum');

const globalSearch = document.getElementById('globalSearch');
const globalStatusFilter = document.getElementById('globalStatusFilter');
const globalSortBy = document.getElementById('globalSortBy');
const exportAllCsvBtn = document.getElementById('exportAllCsvBtn');
const copyAllJsonBtn = document.getElementById('copyAllJsonBtn');

// Modal refs
const ordersModal = document.getElementById('ordersModal');
const modalTitle = document.getElementById('modalTitle');
const closeOrdersBtn = document.getElementById('closeOrdersBtn');
const closeOrdersBtn2 = document.getElementById('closeOrdersBtn2');
const ordersTbody = document.getElementById('ordersTbody');
const rowsCountEl = document.getElementById('rowsCount');
const sumAmountEl = document.getElementById('sumAmount');
const searchBox = document.getElementById('searchBox');
const statusFilter = document.getElementById('statusFilter');
const sortBy = document.getElementById('sortBy');
const downloadCsvBtn = document.getElementById('downloadCsvBtn');

let filteredOrders = [];
let currentModalOrder = null;
let currentFilteredRows = [];

// Add this line to declare data globally
let data = [];

/** ------------------ Render global list ------------------ */
function renderOrders(){
  ordersList.innerHTML = '';
  let grandTotal = 0;

  filteredOrders.forEach(order => {
    const ordersArr = parseOrderSummary(order.order_summary);
    grandTotal += sumAllOrders(ordersArr);

    const stats = [
      { label: 'ID', value: order.id },
      { label: 'User ID', value: order.user_id },
      { label: 'Status', value: statusBadge(order.status) },
      { label: 'Total Amount', value: `₹${formatCurrency(order.total_amount)}` },
      { label: 'Created At', value: order.created_at },
      { label: 'Amount (All Orders Sum)', value: `₹${formatCurrency(order.amount)}` },
      { label: 'Total Orders', value: order.total },
    ];

    const statsGrid = el('div', { class: 'grid' });
    stats.forEach(s => {
      const node = el('div', { class: 'stat' }, [
        `<span class="label">${s.label}</span>`,
        `<span class="value">${s.value}</span>`
      ]);
      statsGrid.appendChild(node);
    });

    let order_data = { ...order };
    order_data['order_summary'] = ordersArr;

    const card = el('div', { class: 'card' }, [
      el('h2', {}, [ `Order #${order.id}` ]),
      statsGrid,
      el('div', { class: 'actions' }, [
        el('button', { onclick: () => openOrderModal(order) }, [ `View Orders (${ordersArr.length})` ]),
        el('button', { class: 'outline', onclick: () => exportOrderCsv(order) }, [ 'Export CSV (This Order)' ]),
        el('button', { class: 'outline', onclick: async () => {
          await copyToClipboard(JSON.stringify(order_data, null, 2));
        } }, [ 'Copy JSON (This Order)' ])
      ])
    ]);

    ordersList.appendChild(card);
  });

  ordersCountEl.textContent = filteredOrders.length;
  grandSumEl.textContent = formatCurrency(grandTotal);
}

/** ------------------ Global Filter/Sort ------------------ */
function applyGlobalFilters(){
  const q = globalSearch.value.trim().toLowerCase();
  const st = globalStatusFilter.value;
  const sort = globalSortBy.value;

  filteredOrders = data.filter(o => {
    const hitQ = !q || [
      o.id, o.user_id, o.status, o.created_at, o.total_amount, o.amount, o.total
    ].some(v => String(v).toLowerCase().includes(q));
    const hitS = !st || o.status === st;
    return hitQ && hitS;
  });

  filteredOrders.sort((a, b) => {
    switch(sort){
      case 'created-asc': return new Date(a.created_at) - new Date(b.created_at);
      case 'created-desc': return new Date(b.created_at) - new Date(a.created_at);
      case 'amount-asc': return (a.total_amount || 0) - (b.total_amount || 0);
      case 'amount-desc': return (b.total_amount || 0) - (a.total_amount || 0);
      default: return 0;
    }
  });

  renderOrders();
}

/** ------------------ Modal (single order) ------------------ */
function openOrderModal(order){
  currentModalOrder = order;
  modalTitle.textContent = `Order #${order.id} – Order Summary`;
  searchBox.value = '';
  statusFilter.value = '';
  sortBy.value = 'time-desc';
  renderModalTable();
  ordersModal.showModal();
}

[closeOrdersBtn, closeOrdersBtn2].forEach(btn => btn.addEventListener('click', () => ordersModal.close()));
ordersModal.addEventListener('cancel', e => { e.preventDefault(); ordersModal.close(); });

[searchBox, statusFilter, sortBy].forEach(elm => elm.addEventListener('input', renderModalTable));

function renderModalTable(){
  const orders = parseOrderSummary(currentModalOrder.order_summary);
  const q = searchBox.value.trim().toLowerCase();
  const stat = statusFilter.value;

  currentFilteredRows = orders.filter(o => {
    const hitQ = !q || o.time.toLowerCase().includes(q) || o.status.toLowerCase().includes(q) || String(o.amount).includes(q);
    const hitS = !stat || o.status === stat;
    return hitQ && hitS;
  });

  currentFilteredRows.sort((a,b) => {
    switch(sortBy.value){
      case 'time-asc': return new Date(a.time) - new Date(b.time);
      case 'time-desc': return new Date(b.time) - new Date(a.time);
      case 'amount-asc': return a.amount - b.amount;
      case 'amount-desc': return b.amount - a.amount;
      default: return 0;
    }
  });

  ordersTbody.innerHTML = '';
  let sum = 0;
  currentFilteredRows.forEach(o => {
    sum += o.amount;
    const tr = el('tr', {}, [
      `<td class="nowrap">${o.time}</td>`,
      `<td>₹${formatCurrency(o.amount)}</td>`,
      `<td>${statusBadge(o.status)}</td>`
    ]);
    ordersTbody.appendChild(tr);
  });

  rowsCountEl.textContent = currentFilteredRows.length;
  sumAmountEl.textContent = formatCurrency(sum);
}

/** ------------------ CSV Exports ------------------ */
function exportOrderCsv(order){
  const rows = parseOrderSummary(order.order_summary);
  const payload = rows.map(r => ({
    order_id: order.id,
    user_id: order.user_id,
    created_at: order.created_at,
    status_header: order.status,
    time: r.time,
    amount: r.amount,
    status: r.status
  }));
  const csv = toCSV(payload);
  downloadBlob(csv, `order_${order.id}.csv`, 'text/csv;charset=utf-8;');
}

downloadCsvBtn.addEventListener('click', () => {
  if(!currentModalOrder) return;
  exportOrderCsv(currentModalOrder);
});

exportAllCsvBtn.addEventListener('click', () => {
  const allRows = [];
  data.forEach(order => {
    const rows = parseOrderSummary(order.order_summary);
    rows.forEach(r => {
      allRows.push({
        order_id: order.id,
        user_id: order.user_id,
        created_at: order.created_at,
        status_header: order.status,
        time: r.time,
        amount: r.amount,
        status: r.status
      });
    });
  });
  const csv = toCSV(allRows);
  downloadBlob(csv, `orders_all.csv`, 'text/csv;charset=utf-8;');
});

/** ------------------ Utils ------------------ */
function toCSV(objArray){
  const arr = Array.isArray(objArray) ? objArray : [objArray];
  if(arr.length === 0) return '';
  const headers = Object.keys(arr[0]);
  const rows = [headers, ...arr.map(o => headers.map(h => o[h]))];
  return rows.map(r => r.map(String).map(v => `"${v.replace(/"/g,'""')}"`).join(',')).join('\n');
}

function downloadBlob(content, filename, type){
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    alert('JSON copied!');
  }catch(e){
    alert('Clipboard write failed.');
  }
}

/** ------------------ Init ------------------ */
fetch('http://localhost:800/data.php', {
  method: 'GET',
})
.then(response => response.json())
.then(respData => {
    if(!Array.isArray(respData) || respData.length === 0){
      throw new Error('No data found');
    }
    console.log('Fetched data:', respData);
    
    // Assign to global data variable
    data = [...respData];
    let ordersArr = [...respData];
    filteredOrders = [...respData];
    rawDataEl.textContent = JSON.stringify(ordersArr, null, 2);
    applyGlobalFilters();

    [globalSearch, globalStatusFilter, globalSortBy].forEach(elm => elm.addEventListener('input', applyGlobalFilters));

    copyAllJsonBtn.addEventListener('click', async () => {
      await copyToClipboard(JSON.stringify(ordersArr, null, 2));
    });
})
.catch(error => {
  console.error('Error:', error);
});
</script>
</body>
</html>
