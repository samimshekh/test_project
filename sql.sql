CREATE TABLE `my_test_project`.`orders` (`id` INT NOT NULL AUTO_INCREMENT , `user_id` INT NOT NULL , `status` ENUM('pending', 'paid', 'completed', 'cancelled') NOT NULL , `total_amount` INT NOT NULL , `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP , PRIMARY KEY (`id`)) ENGINE = InnoDB;
INSERT INTO `my_test_project`.`orders` (`user_id`, `status`, `total_amount`, `created_at`) VALUES
(1, 'completed', 1000, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(2, 'completed', 1200, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(3, 'completed', 1300, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(4, 'completed', 1500, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(5, 'completed', 1600, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(6, 'completed', 1700, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(7, 'completed', 1800, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(8, 'completed', 1900, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(1, 'completed', 1100, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(2, 'completed', 1250, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(3, 'completed', 1350, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(4, 'completed', 1550, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(5, 'completed', 1650, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(6, 'completed', 1750, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(7, 'completed', 1850, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(8, 'completed', 1950, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(1, 'completed', 1020, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(2, 'completed', 1220, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(3, 'completed', 1320, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(4, 'completed', 1520, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(5, 'completed', 1620, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(6, 'completed', 1720, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(7, 'completed', 1820, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(8, 'completed', 1920, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(1, 'completed', 1030, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(2, 'completed', 1230, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(3, 'completed', 1330, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(4, 'completed', 1530, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(5, 'completed', 1630, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(6, 'completed', 1730, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(7, 'completed', 1830, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(8, 'completed', 1930, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(1, 'completed', 1040, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(2, 'completed', 1240, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(3, 'completed', 1340, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(4, 'completed', 1540, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(5, 'completed', 1640, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(6, 'completed', 1740, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(7, 'completed', 1840, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(8, 'completed', 1940, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(1, 'completed', 1050, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(2, 'completed', 1250, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(3, 'completed', 1350, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(4, 'completed', 1550, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(5, 'completed', 1650, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(6, 'completed', 1750, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(7, 'completed', 1850, DATE_SUB(NOW(), INTERVAL 90 DAY)),
(8, 'completed', 1950, DATE_SUB(NOW(), INTERVAL 90 DAY));
SELECT *, SUM(total_amount) as amount, COUNT(*) as total, GROUP_CONCAT(CONCAT(created_at, '|', total_amount, '|', status) ORDER BY created_at ASC SEPARATOR ',') AS order_summary FROM `orders` GROUP BY user_id HAVING created_at <= DATE_SUB(NOW(), INTERVAL 1 HOUR) and status IN ('paid', 'completed') ORDER BY total_amount DESC LIMIT 0,4;
